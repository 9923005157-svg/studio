/**
 * @fileoverview Firestore Security Rules for PharmaTrust application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for Manufacturers, Distributors, Pharmacies, and Patients. Each entity can only be created, read, updated, or deleted by the authenticated user whose ID matches the entity's ID.  FDA Approvals are publicly readable, but only Manufacturers can create them. Only users with the 'FDA' role can update the status of an approval.
 *
 * Data Structure:
 * - /users/{userId}
 * - /manufacturers/{manufacturerId}
 * - /distributors/{distributorId}
 * - /pharmacies/{pharmacyId}
 * - /patients/{patientId}
 * - /fda_approvals/{fdaApprovalId}
 *
 * Key Security Decisions:
 * - Users can only manage their own resources (user profile, manufacturers, distributors, pharmacies, patients).
 * - FDAApprovals are publicly readable to allow information sharing.
 * - Only Manufacturers can create FDAApprovals.
 * - Only users with the 'FDA' role can update the 'status' field of an FDAApproval.
 * - Only users with the 'Distributor' role can update the 'shipmentStatus' field.
 * - Manufacturers can delete their own FDAApprovals.
 *
 * Denormalization for Authorization:
 * - FDAApproval documents MUST contain the manufacturerId to authorize create/delete operations.
 * - The `users` collection is checked to verify a user's role for FDA approval updates.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user documents. Users can create their own user document and read it. Updates are disallowed.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow update, delete: if false; // Role changes handled by backend logic, not direct client updates
    }
    
    /**
     * @description Controls access to manufacturer documents. Each manufacturer can only manage their own data.
     * @path /manufacturers/{manufacturerId}
     */
    match /manufacturers/{manufacturerId} {
      function isOwner(manufacturerId) {
        return request.auth != null && request.auth.uid == manufacturerId;
      }

      function isExistingOwner(manufacturerId) {
        return isOwner(manufacturerId) && resource != null;
      }

      function isAuthenticated() {
        return request.auth != null;
      }

      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      allow create: if isOwner(manufacturerId);
      allow update: if isExistingOwner(manufacturerId);
      allow delete: if isExistingOwner(manufacturerId);
    }

    /**
     * @description Controls access to distributor documents. Each distributor can only manage their own data.
     * @path /distributors/{distributorId}
     */
    match /distributors/{distributorId} {
      function isOwner(distributorId) {
        return request.auth != null && request.auth.uid == distributorId;
      }

      function isExistingOwner(distributorId) {
        return isOwner(distributorId) && resource != null;
      }

      function isAuthenticated() {
        return request.auth != null;
      }

      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      allow create: if isOwner(distributorId);
      allow update: if isExistingOwner(distributorId);
      allow delete: if isExistingOwner(distributorId);
    }

    /**
     * @description Controls access to pharmacy documents. Each pharmacy can only manage their own data.
     * @path /pharmacies/{pharmacyId}
     */
    match /pharmacies/{pharmacyId} {
      function isOwner(pharmacyId) {
        return request.auth != null && request.auth.uid == pharmacyId;
      }

      function isExistingOwner(pharmacyId) {
        return isOwner(pharmacyId) && resource != null;
      }

      function isAuthenticated() {
        return request.auth != null;
      }



      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      allow create: if isOwner(pharmacyId);
      allow update: if isExistingOwner(pharmacyId);
      allow delete: if isExistingOwner(pharmacyId);
    }

    /**
     * @description Controls access to patient documents. Each patient can only manage their own data.
     * @path /patients/{patientId}
     */
    match /patients/{patientId} {
      function isOwner(patientId) {
        return request.auth != null && request.auth.uid == patientId;
      }

      function isExistingOwner(patientId) {
        return isOwner(patientId) && resource != null;
      }

      function isAuthenticated() {
        return request.auth != null;
      }

      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Controls access to FDA approval documents.
     * @path /fda_approvals/{fdaApprovalId}
     */
    match /fda_approvals/{fdaApprovalId} {
      function isFdaUser() {
        return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FDA';
      }
      
      function isDistributorUser() {
          return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Distributor';
      }

      function isManufacturerOwner() {
        return request.auth != null && resource.data.manufacturerId == request.auth.uid;
      }
      
      function isCreatingManufacturer() {
        return request.auth != null && request.resource.data.manufacturerId == request.auth.uid;
      }
      
      function isUpdatingShipmentStatus() {
        // Allow update if the 'shipmentStatus' is being changed and the 'status' is not.
        let incomingData = request.resource.data;
        return incomingData.shipmentStatus != resource.data.shipmentStatus && incomingData.status == resource.data.status;
      }
      
      function isUpdatingFdaStatus() {
        // Allow update if the 'status' is being changed and the 'shipmentStatus' is not.
        let incomingData = request.resource.data;
        return incomingData.status != resource.data.status && incomingData.shipmentStatus == resource.data.shipmentStatus;
      }

      // Public read access
      allow get: if true;
      allow list: if true;

      // Manufacturer can create
      allow create: if isCreatingManufacturer();
      
      // FDA can update 'status', Distributor can update 'shipmentStatus'
      allow update: if (isFdaUser() && isUpdatingFdaStatus()) || (isDistributorUser() && isUpdatingShipmentStatus());

      // Manufacturer can delete
      allow delete: if isManufacturerOwner();
    }
  }
}
